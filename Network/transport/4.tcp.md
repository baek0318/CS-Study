# TCP
>Author: 백승화  
>Created: 2021년 10월 3일  
>Tags: `tcp`

## TCP 연결
TCP 프로토콜인 경우에는 애플리케이션 프로레스가 데이터를 다른 프로세스에게 보내기 전에  
두 프로세스가 서로 핸드셰이크를 먼저해야하므로 연결지향형이다  
### 특징
- 종단간 시스템에서만 동작
  - tcp는 프로세스와 프로세스 사이에서 작동하는 것이기 때문에  
    중간에 패킷을 전달하는 네트워크 요소인 라우터나 스위치에서는 tcp연결상태를 유지하지 않는다 
- 점대점
  - 하나의 송신자가 여러명의 수신자에게 한꺼번에 메세지를 전달하는 행위를 하지 못한다  
    하나의 송신자는 하나의 수신자에게만 데이터를 전달해야한다
- 전이중 서비스
  - a와 b사이에 tcp연결이 확립되어있다면  
    a->b로 보내는 동시에 b->a로 보낼 수 있다  
    
## TCP 세그먼트 구조

### 순서번호와 확인응답 번호
- `순서번호` : 데이터 스트림을 사이즈에 맞게 자르는데 해당 사이즈마다 첫번째 데이터 스트림의 번호를 이야기한다  
          예) 1500 길이를 3으로 나눈다면 순서번호는 0, 500, 1000이 된다
  
- `확인응답번호` : 호스트 A가 호스트 B로 부터 데이터를 받은 경우 호스트 A는 호스트 B에게 바라는 다음 데이터의 순서번호를 적는 공간이다

**TCP에서 순서가 바껴서 도착한 경우**  
개발자의 구현에 따라서 다르다  
1. 수신자가 순서가 틀린 세그먼트를 버린다
2. 수신자가 순서가 틀린 세그먼트는 버퍼링을하고 제대로된 응답이 들어올때 까지 기다린다  

**실제로 순서번호를 설정하는 방식**  
실제로 순서번호를 설정하는 방법은 난수를 사용하는 방법이다  
왜냐하면 동일한 출발지 목적지 포트에서 새로운 연결설정을 했을 때  
네트워크에 남아있던 패킷이 목적지 포트나 출발지 포트에 도착한 경우  
이전의 데이터인지 현재 데이터인지 구분하기가 어렵기 때문이다  

## 신뢰적 데이터 전송 방법
트랜스포트 계층 하위에 존재하는 네트워크 계층에서 사용되는 ip는 데이터에대한 어떠한 것도 보장해주지 못한다  
그래서 트랜스포트 계층에서 tcp 프로토콜을 사용하게 된다면  
애플리케이션 계층에서는 데이터를 손실없이 순서대로 받을 수 있게끔 보장해준다  

rdt와의 차이점은 어떠한 상황에서도 단일 타이머를 사용한다  

### 응답 시나리오
1. 패킷을 전달하고 ack패킷을 시간내에 받지 못한경우
2. 순서번호 92, 100 패킷을 연속해서 보냈는데 ack응답이 첫번째 시간에 못들어오고 두번째 시간에 들어온 경우
3. 순서번호 92, 100 패킷을 연속해서 보냈는데 92 응답은 도착하지 못하고 100 응답만 도착한경우 

### 타임아웃 주기 설정
예를 들어서 초기에 0.75초 라고 설정을 했는데 타임아웃이 발생한다면  
그 다음 시간을 1.5초로 설정하고 또 타임아웃이 발생한다면 `시간*2` 를 함으로 재설정해준다  

**예외**  
상위 애플리케이션으로부터 데이터를 전달받는 경우와 ACK를 수신한 경우에는  
EstimatedRTT, DevRTT를 사용한다  

### 빠른 재전송
특정 패킷이 손실되고 해당 패킷에 대한 타임아웃이 발생하기전에 패킷이 손실되었음을 알고 재전송하는 방법이다    

**어떻게 알 수 있냐면**  
수신자가 누적 ack로 가지고 있는 최근의 ack가 100이라면  
101번째 순서번호의 패킷이 손실되었고  
그 뒤로 전송된 3개의 패킷이 제대로 수신자측에 전송되었다면  
수신자 측에 정상적으로 전달된 3개의 패킷의 ack로 100이 중복 ack로 송신자측에 전달되게 된다  
송신자측은 3개의 연속된 중복 ack를 받음으로써 101번째 패킷이 손실 되었음을 알고 빠른 재전송을 하게된다  


