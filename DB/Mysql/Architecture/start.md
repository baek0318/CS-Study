# Mysql의 전반적인 구조와 원리
>Author: 백승화  
>Created: 2021년 9월 16일 오후 12:19  
>Tags: `Thread`, `Memory`, `plugin`, `component`

## Mysql의 전체구조
### Mysql 엔진
- 커넥션 핸들러
- SQL 파서
- SQL 전처리기
- 옵티마이저
- 캐시 & 버퍼 

위의 것들을 합쳐서 Mysql 엔진이라고 부른다
### 스토리지 엔진
- 디스크 스토리지에 저장
- 디스크 스토리지에서 읽어오기

`특징` : 하나의 DB에서 여러개의 스토리지 엔진을 사용할 수 있다

>Mysql엔진 + 스토리지 엔진 = Mysql 서버

### Handler api
mysql 엔진에서 스토리지 엔진과 서로 소통해야하는 경우  
handler api를 통해서 서로 정보를 주고받는다  

## 쓰레딩 구조
Mysql 서버는 쓰레드 기반으로 동작한다  
크게 Foreground 와 Background로 구분할 수 있다 
### Foreground Thread
포그라운드 쓰레드는 최소한 서버에 접속된 클라이언트 수만큼 존재한다
- 순서
  1. 클라이언트 접속 : 쓰레드 생성
  2. 사용자 요청 쿼리 처리
  3. 작업 마침 : 쓰레드 캐시로 복귀
     1. 쓰레드 캐시에 필요이상으로 많은 경우 해당 쓰레드 즉시 삭제

|MyISAM|InnoDB|
|---|---|
|디스크 쓰기까지 포그라운드 쓰레드가 담당|데이터 버퍼나 캐시까지만 포그라운드가 담당|

### Background Thread(InnoDB만 거의 해당)
- 인서트 버퍼를 병합하는 역할
- 로그를 디스크로 기록
- InnoDB 버퍼 풀의 데이터를 디스크에 기록
- 데이터를 버퍼로 읽어오기
- 잠금이나 데드락을 모니터링

일반적인 상용 DBMS는 버퍼에 쓰고 한꺼번에 디스크에 기록이 가능함  
하지만 MyISAM에서는 포그라운드가 전부 처리하기 때문에 쓰기에서 비교적 느리다  

## 메모리 사용구조
모든 쓰레드가 공유하고 시스템에서 크기를 할당해주는 글로벌 메모리 영역  
하나의 쓰레드에서 독립적으로 사용하는 로컬 메모리 영역이 존재한다

### 글로벌 메모리 영역
일반적으로 클라이언트 쓰레드의 개수와 무관하게 하나의 메모리 영역만 할당받는다  
필요에 의해서 N개가 생성되더라도 모두 공유된다  
- 테이블 캐시
- InnoDB 버퍼 풀
- InnoDB 어댑티브 해시 인덱스
- InnoDB redo 로그 버퍼


### 로컬 메모리 영역 
클라이언트 쓰레드가 쿼리를 처리하는데 사용한는 메모리 영역이다  
그래서 클라이언트 메모리 영역이라고 불리기도 한다  
또는 클라이언트와 서버와의 커넥션을 유지하기도 하기 때문에 세션 메모리 영역으로도 불린다  
로컬 메모리는 독립적으로 할당되어 쓰레드사이에 공유되지 않는다  
- 커넥션이 열려있는 동안 계속 할당되어져 있는 상태 (커넥션 버퍼, 결과 버퍼)
- 쿼리를 실행하는 순간에만 할당했다가 해체하는 상태 (조인 버퍼, 소트 버퍼)

 


