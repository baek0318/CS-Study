# Lock

Author: 백승화
Created: 2020년 12월 31일 오전 10:59
Tags: Lock, Transaction

MySQL 잠금에는 MySQL 엔진 레벨, 스토리지 엔진 레벨이 존재한다

## MySQL 엔진 레벨

### Global Lock

범위가 가장 큰 Lock이다

Select를 제외한 대부분의 DML DDL 문장들은 대기한다

`범위` : MySQL 전체

### Table Lock

개별 테이블 단위로 적용되는 Lock

- 명시적 테이블 잠금
    - 명령어를 통해 명시적으로 잠금을 얻어서 사용 뒤에 명시적으로 해체를 해주어야 한다
- 묵시적 테이블 잠금
    - 데이터 변경 쿼리를 사용하면 자동 생성되었다가 해체된다 (MyISAM)
    - InnoDB인 경우에는 record lock을 사용한다

`범위` : 테이블

### Named Lock

사용자가 지정한 문자열에 접근하려고 할 때 Lock을 사용한다

`범위` : 문자열

### Metadata Lock

데이터베이스의 테이블이나 뷰의 구조를 변경하는데 사용된다

`범위` : ?

## InnoDB 엔진 레벨

### Record Lock

레코드 자체를 잠그는 것으로 테이블 수준보다 낮은 수준의 잠금으로 볼 수 있다

InnoDB에서는 record lock은 인덱스 잠금으로 구현된다

`범위` : 테이블 내의 레코드

### Gap Lock

레코드와 레코드 사이의 간격을 lock하는 것이다

레코드와 레코드 사이의 새로운 데이터가 들어오는 것을 막는다는 이야기다

`범위` : 테이블 내의 레코드

### Next Key Lock

record lock + gap lock 이라고 한다

많이 사용하지 않는 것이 좋다

### Auto Increment Lock (테이블 수준)

자동증가 row id를 사용하는 테이블인 경우에는 여러개의 데이터가 동시에 insert가 발생했을 때

중복한 row id를 생성하면 안되기 때문에 lock을 걸어서 실행을 한다

`범위` : 테이블?

### Index와 Lock의 관계

InnoDB는 record lock을 할 때 인덱스 잠금을 사용하게 된다

**인덱스 잠금을 사용한다는 것은...**

특정 데이터를 수정하기 위해서 검색할 때 인덱스를 타서 검색된 모든 레코드들은 잠금이 실행된다는 이야기다

검색 되는 테이블에 인덱스가 존재하지 않는다면 테이블이 잠금된다

**결과적으로...**

InnoDB를 사용할 때는 인덱스 정책을 제대로 사용하지 않는다면 병렬 트랜잭션 처리가 제대로 되지 않는다
