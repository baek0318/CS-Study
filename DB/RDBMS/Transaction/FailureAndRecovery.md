# 장애와 회복
데이터베이스는 모순이 없는 일관된 상태를 유지하기 위해 DBMS에서는 회복 기능을 제공한다

### 장애 유형
|유형|설명|
|---|---|
|트랜잭션 장애| 트랜잭션 수행 중 오류가 발생하여 정상적으로 수행을 계속할 수 없는 상태|
|시스템 장애|하드웨어의 결함으로 정상적으로 수행을 계속할 수 없는 상태|
|미디어 장애|디스크 장치의 결함으로 디스크에 저장된 데이터베이스의 일부 혹은 전체가 손상된 상태|

### 데이터베이스 저장연산
|저장 장치|설명|
|---|---|
|휘발성 저장 장치|장애가 발생하면 저장된 데이터 손실 예) 메인 메모리|
|비휘발성 저장 장치|장애가 발생해도 저장된 데이터가 손실되지 않음 단 디스크 자체에 장애가 생기면 손실됨 예 ) 하드|
|안정 저장 장치|비휘발성 저장장치를 이용해 데이터 복사본을 여러개 만드는 방법|

디스크와 메인 메모리 사이에는 블록 단위로 데이터가 움직인다
- `디스크 블록` : 디스크에 존재하는 데이터 블록을 가리킨다
- `버퍼 블록` : 메인 메모리에 존재하는 데이터 블록을 가리킨다
- `input(x)` : 디스크에 있는 데이터 블록을 메인 메모리로 가져온다
- `output(x)` : 메인 메모리에 있는 데이터 블록을 디스크로 내보낸다
  
메인 메모리와 애플리케이션 사이에 발생하는 연산
- `read(x)` : 메인 메모리의 데이터 블록을 애플리케이션 변수로 가져간다
- `write(x)` : 애플리케이션 변수를 메인 메모리로 내보낸다  

## 회복 기법
DBMS에 회복 관리자가 담당하는 영역으로써 장애가 발생하기 전의 상태로 만들어주는 행위를 한다  
보통은 복구하는 동안 DB에 접근 금지이므로 빠르게 해결해야한다  

### 데이터 복사 방법
- `덤프 (dump)` : 데이터베이스 전체를 주기적으로 다른곳에 복사하는 방법
- `로그 (log)` : 트랜잭션이 실행될 때마다 변경하기 이전값과 이후값을 별도의 파일에 기록

### 데이터 복구 방법
- `재실행 (redo)` : 가장 최근 DB 복사본을 가져와서 로그를 이용해 최근 상태로 복구한다
- `취소 (undo)` : 로그를 이용해 최근에 이루어진 트랜잭션을 취소하여 이전 상태로 되돌린다

## 로그 회복 기법
데이테베이스에 결과를 반영하는 시점에 따라 2가지 방법으로 나뉜다

### 즉시 갱신 (immediate update) 회복 기법
`즉시 갱신` : 트랜잭션 수행중에 데이터 변경한 연산의 결과를 데이터베이스에 즉시 반영하는 것    
장애 발생에 대비해서 데이터 변경내용을 로그 파일에 기록한다  
**연산 순서**  
`데이터 변경연산 실행` -> `로그 파일에 기록` -> `데이터베이스에 반영`  

장애시에 redo나 undo 선택 기준  
- `redo 선택` : 트랜잭션이 완료된 후 장애가 발생한 경우
- `undo 선택` : 트랜잭션이 완료되기 전 장애가 발생한 경우
- `redo undo 둘다 선택하는 경우` : undo를 먼저 실행한 후 redo를 실행한다  

### 지연 갱신 회복 기법
`지연 갱신` : 로그 파일에만 기록해두다가 트랜잭션이 부분완료된 후에 로그에 기록된 내용을 DB에 반영  
`undo는 필요없는 이유` : 완료전에는 DB에 반영하지 않기 때문이다  

장애시에 처리 방법
- `redo 선택` : 트랜잭션이 완료후에 장애가 발생한 경우
- `무시하고 버림` : 트랜잭션이 완료되기전에 장애가 발생한 경우

### 로그 회복 기법 단점
장애가 발생할 경우 로그에 기록된 모든 연산을 가지고 분석을 하고 redo를 할지 undo를 할지 결정해야 함으로  
그 과정속에서 불필요한 리소스를 사용하게 된다

## 검사 시점 회복 기법
로그 회복 기법과 거의 유사하지만 검사 시점 회복 기법은 일정한 간격으로 체크포인트를 만듬으로써  
장애가 발생할 경우 최신 체크포인트 이후 부분에 대해서만 로그 기록을 읽으면서 장애를 해결한다  

## 미디어 회복 기법
디스크에 장애가 발생했을 경우 회복하기 위한 방법이다  
데이터베이스의 데이터를 다른 장소에 일정 간격마다 복사해둔다  
오류가 발생했을 경우 가장 최근에 복사한 데이터를 불러옴으로써 복구를 진행한다  
`단점` : 복사할동안 트랜잭션이 중단되기 때문에 CPU 낭비가 발생한다는 것이다